<!DOCTYPE html>
<html lang=en>
<meta charset="utf-8">
<title>EduBot</title>
<meta name=description content="EduBot">
<meta name=viewport content="width=device-width,initial-scale=1.0">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
<link rel=icon href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3E%3Cpath d='M1,8L1,2L2,2L2,0L3,0L3,2L5,2L5,0L6,0L6,2L7,2L7,8M2,6L2,7L6,7L6,6M2,3L2,4L3,4L3,3M5,3L5,4L6,4L6,3'%3E%3C/path%3E%3C/svg%3E" sizes="any">
<link rel="apple-touch-icon" href="/static/favicon-192.png">
<link rel="mask-icon" href="/static/favicon.svg" color="black">
<link rel=stylesheet href="/static/chota.min.css" media="print" onload="media='all'">
<link rel=stylesheet href="/static/style.css" media="print" onload="media='all'">
<link rel="manifest" href="/static/manifest.json">
<script defer src="/static/vue.global.prod.js"></script>
<script defer src="/static/vue-router.global.prod.js"></script>
<script defer src="/static/markdown-it.min.js"></script>
<script type=module>
import { Sign } from '/static/Sign.js'
import { Profile } from '/static/Profile.js'
import { Leaderboard } from '/static/Leaderboard.js'
import { LessonList, LessonShow, CategoriesList } from '/static/Lesson.js'
import { BotOnlineChat } from '/static/BotOnline.js'
import { Privacy } from '/static/Privacy.js'

const routes = [
	{ path:'/', redirect: ()=> document.cookie ? '/me' : '/sign'},
	{ path:'/sign', component: Sign },
	{ path:'/me', component: Profile },
	{ path:'/category/', component: CategoriesList},
	{ path:'/category/:tag', component: LessonList, props: true},
	{ path:'/lesson/:id', component: LessonShow, props: true },
	{ path:'/leaderboard', component: Leaderboard},
	{ path:'/privacy', component: Privacy},
	{ path:'/:other(.*)*', component:{template:`<h1>404: Page not found ðŸ˜Ÿ</h1>`}}
];
const app = Vue.createApp({
	data() { return {role: null, id: null, progress: {}, theme: localStorage.theme || `#126359`} },
	mounted() { this.log(); },
	computed: {
		xp() { return Object.keys(this.progress).length },
		level() { return this.xp / 100 | 0 }, //level-up every 100 good response
		percent() { return this.xp % 100 }, // TODO: use log(2) progression instead of linear(100)
	},
	methods: {
		is(...roles) { return roles.includes(this.role); },
		log() {
			const cookie = Object.fromEntries(document.cookie.split('; ').map(x => x.split('=')));
			this.id   = cookie.id ? atob(cookie.id) : null;
			this.role = cookie.role ? atob(cookie.role) : null;
		}
	},
});
app.use(VueRouter.createRouter({routes, history: VueRouter.createWebHistory(), linkActiveClass: 'active'}));
app.component('bot-chat', BotOnlineChat);
app.mount('main');
console.debug(app);
if ('serviceWorker' in navigator) {
	navigator.serviceWorker.register('/worker.js').then(console.debug);
}
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
	document.body.classList.add('dark');
}
</script>
<main class="container">
	<component is="style">:root{--color-primary: {{theme}};}</component>
	<nav class="tabs is-full" style="z-index: 1;margin-bottom: 2em;position: sticky;top: 0;background: var(--bg-color);">
		<router-link to="/category" v-if="is('admin','user')"><s>book</s><span>à¸šà¸—à¹€à¸£à¸µà¸¢à¸™</span></router-link>
		<router-link to="/category/vocab" v-if="is('admin','user')"><s>bookmark</s><span>à¸„à¸³à¸¨à¸±à¸žà¸—à¹Œ</span></router-link>
		<router-link to="/user/" v-if="is('admin')"><s>group</s><span>Users</span></router-link>
		<router-link to="/me" v-if="is('admin','user')"><s>bust</s><span>{{$root.id}}</span> <span class="tag is-small" :title="'xp:'+xp">Lv:{{level}}</span></router-link>
		<router-link to="/sign" v-if="is(null)"><s>star</s><span>Sign Up</span></router-link>
		<router-link to="/leaderboard" v-if="is('admin','user')"><s>trophy</s><span>Leaderboard</span></router-link>
	</nav>	
	<router-view :key="$route.fullPath"></router-view>
	<bot-chat ref="bot" v-if="is('admin','user')"></bot-chat>
</main>	
